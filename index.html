<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TimE BlockS</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Inline SVG favicon to prevent /favicon.ico 404s -->
    <link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%23101220"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, Helvetica, sans-serif" font-size="28" fill="%23f5f5f0">TB</text></svg>' />
  </head>
  <body>
    <header class="app-header">
      <div class="app-header__controls">
        <div class="brand">
          <span class="brand__title">TIME BLOCKS</span>
        </div>
        <div class="app-header__control-group">
          <button class="nav-button" type="button" data-direction="prev" aria-label="Previous week">◀</button>
          <div class="view-toggle-group" role="tablist" aria-label="Select calendar view">
            <button class="view-toggle is-active" type="button" data-view="week" role="tab" aria-selected="true">Week</button>
            <button class="view-toggle" type="button" data-view="month" role="tab" aria-selected="false">Month</button>
          </div>
          <button class="nav-button" type="button" data-direction="next" aria-label="Next week">▶</button>
          <div class="app-header__range" id="header-range">Loading…</div>
          <button id="open-report" class="app-header__report" type="button" title="Open report" aria-label="Open report">
            <!-- Inline SVG report icon (monochrome, matches provided art) -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128" width="32" height="32" aria-hidden="true" focusable="false">
              <!-- Document outline with folded corner -->
              <path d="M22 16 H86 L110 40 V110 H22 Z" fill="none" stroke="currentColor" stroke-width="10" stroke-linejoin="round" stroke-linecap="round" />
              <!-- Folded corner triangle (stroke only) -->
              <path d="M86 16 L110 40 L86 40 Z" fill="none" stroke="currentColor" stroke-width="10" stroke-linejoin="round" stroke-linecap="round" />

              <!-- Rounded baseline and bars: filled shapes to match thick, rounded look -->
              <rect x="30" y="78" width="12" height="18" rx="4" fill="currentColor" />
              <rect x="50" y="66" width="12" height="30" rx="4" fill="currentColor" />
              <rect x="70" y="52" width="12" height="44" rx="4" fill="currentColor" />
              <rect x="28" y="92" width="58" height="10" rx="4" fill="currentColor" />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <main class="app-shell" id="app">
      <!-- Content will be injected by app.js -->
    </main>

    <footer class="app-footer">
      <p>Built with vanilla HTML, CSS, and JavaScript.</p>
      <div class="storage-controls">
        <button id="save-local" type="button">Save Locally</button>
        <button id="load-local" type="button">Load Local</button>
        <button id="clear-local" type="button">Clear Local</button>
        <span id="storage-status" aria-live="polite"></span>
      </div>
      <div class="cloud-controls" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <button id="save-cloud" type="button" disabled>Save to Cloud</button>
        <button id="load-cloud" type="button" disabled>Load from Cloud</button>
      </div>
      

      <!-- Email/Password Auth (Signup & Login) -->
      <section class="email-auth" style="margin-top:12px; display:grid; gap:8px;">
        <div id="auth-forms">
          <div>
            <h2 style="margin:0 0 4px; font-size:16px;">Sign Up</h2>
            <input type="email" id="signup-email" placeholder="Email" />
            <input type="password" id="signup-password" placeholder="Password" />
            <button onclick="signup()">Sign Up</button>
          </div>
          <div>
            <h2 style="margin:8px 0 4px; font-size:16px;">Log In</h2>
            <input type="email" id="login-email" placeholder="Email" />
            <input type="password" id="login-password" placeholder="Password" />
            <button onclick="login()">Log In</button>
          </div>
        </div>
        <div>
          <h2 style="margin:8px 0 4px; font-size:16px;">Status</h2>
          <p id="status">Not logged in</p>
          <button onclick="logout()" id="email-logout">Log Out</button>
        </div>
      </section>
    </footer>

    <!-- Firebase modular SDK (ES modules) -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
      import { getAuth } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

      // Your Firebase configuration (updated)
      const firebaseConfig = {
        apiKey: "AIzaSyCfnTVWU2ss7Hk__h8GCJiOnpjvJP_1ktk",
        authDomain: "time-blox.firebaseapp.com",
        projectId: "time-blox",
        storageBucket: "time-blox.firebasestorage.app",
        messagingSenderId: "827535870653",
        appId: "1:827535870653:web:7a570b67b47e437f5185d4",
        measurementId: "G-9KB1GTN51M"
      };

      // Initialize Firebase (modular API)
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Expose minimal handles for legacy code paths; prefer importing in modules.
      window.firebaseApp = app;
      window.firebaseAuth = auth;
      window.firebaseDb = db;
      window.firebaseConfig = firebaseConfig;
    </script>

    <!-- Email/Password auth helpers using modular SDK -->
    <script type="module">
      import { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

      const authHandle = window.firebaseAuth;
      if (!authHandle) {
        console.warn('Firebase Auth not initialized; email/password UI will be disabled.');
      }

      function byId(id) { return document.getElementById(id); }
      function setStatus(text) { const el = byId('status'); if (el) el.textContent = text; }
      const emailLogoutBtn = document.getElementById('email-logout');
      const authForms = document.getElementById('auth-forms');
      const signupEmail = byId('signup-email');
      const signupPass = byId('signup-password');
      const loginEmail = byId('login-email');
      const loginPass = byId('login-password');
      const saveCloudBtn = document.getElementById('save-cloud');
      const loadCloudBtn = document.getElementById('load-cloud');

      // Make globally accessible for inline onclick handlers
      function validEmail(v){ return /.+@.+\..+/.test(v); }
      function withLoading(btn, fn){
        if (!btn) return fn();
        const original = btn.textContent;
        btn.disabled = true; btn.textContent = 'Please wait…';
        return Promise.resolve(fn()).finally(()=>{ btn.disabled = false; btn.textContent = original; });
      }

      function showAuthError(err) {
        console.warn('Firebase auth error', err);
        const msg = err?.message || String(err);
        if (/api-key-not-valid|api key not valid/i.test(msg) || /auth\/api-key-not-valid/i.test(err?.code)) {
          alert('Firebase configuration error: API key not valid. Check your `firebaseConfig` in index.html and ensure the API key is correct and the hosting domain is authorized in the Firebase Console.');
          return;
        }
        if (/domain not authorized/i.test(msg) || /unauthorized-domain/i.test(err?.code)) {
          alert('Authentication error: This domain is not authorized for your Firebase project. Add the site domain in Firebase Console > Authentication > Authorized domains.');
          return;
        }
        alert(msg);
      }

      window.signup = function signup() {
        const email = signupEmail?.value?.trim() || '';
        const password = signupPass?.value || '';
        if (!validEmail(email)) { alert('Enter a valid email'); return; }
        if (password.length < 6) { alert('Password must be at least 6 characters'); return; }
        withLoading(signupPass?.nextElementSibling, () =>
            createUserWithEmailAndPassword(authHandle, email, password)
              .then((cred) => setStatus(`Signed up: ${cred.user?.email || cred.user?.uid}`))
        ).catch(showAuthError);
      };

      window.login = function login() {
        const email = loginEmail?.value?.trim() || '';
        const password = loginPass?.value || '';
        if (!validEmail(email)) { alert('Enter a valid email'); return; }
        if (!password) { alert('Enter your password'); return; }
        withLoading(loginPass?.nextElementSibling, () =>
          signInWithEmailAndPassword(authHandle, email, password)
            .then((cred) => setStatus(`Logged in: ${cred.user?.email || cred.user?.uid}`))
        ).catch(showAuthError);
      };

      window.logout = function logout() {
        signOut(auth).catch((err) => alert(err?.message || String(err)));
      };

  onAuthStateChanged(authHandle, (user) => {
        if (user) {
          setStatus(`Logged in as: ${user.email || user.uid}`);
          if (emailLogoutBtn) emailLogoutBtn.hidden = false;
          if (authForms) authForms.style.display = 'none';
          if (saveCloudBtn) saveCloudBtn.disabled = false;
          if (loadCloudBtn) loadCloudBtn.disabled = false;
        } else {
          setStatus('Not logged in');
          if (emailLogoutBtn) emailLogoutBtn.hidden = true;
          if (authForms) authForms.style.display = '';
          if (saveCloudBtn) saveCloudBtn.disabled = true;
          if (loadCloudBtn) loadCloudBtn.disabled = true;
        }
      });
    </script>

    <script src="app.js" type="module"></script>
    <script>
      // Poll the special file `__livereaload` and reload the page when it changes.
      (function() {
        let last = null;
        async function check() {
          try {
            const res = await fetch('/__livereaload', { cache: 'no-store' });
            if (!res.ok) return;
            const text = await res.text();
            if (last && last !== text) {
              console.info('Live-reload: change detected, reloading');
              location.reload(true);
              return;
            }
            last = text;
          } catch (e) {
            // ignore network errors
          }
        }
        // initial check and start polling every second
        check();
        setInterval(check, 1000);
      })();
    </script>
  </body>
</html>
